---
title: "Action Asymmetry Experiment (n = 1008): Figures for CogSci 2023 submission"
pagetitle: "aah | exp | figures"
author: "Owen Morgan"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

<style type="text/css">
  body{
  font-family: Avenir;
  font-size: 12pt;
}
</style>

---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.align = "center", fig.width = 9,
                      fig.height = 6, results = "asis")
options(knitr.kable.NA = "")

cli.progress_show_after <- 0

## Do not use scientific notation until 9 decimal places.
options(scipen = 9, digits = 9)

# Suppress summarise info
options(dplyr.summarise.inform = FALSE)
```

```{r lib}
library(here)
library(tidyverse)
library(cli) # For printing error messages

library(lme4)
library(emmeans)
library(broom)
library(gt)

library(ggpubr) ## functions for plotting SD, SEM, CI.
library(ggbeeswarm)
library(patchwork)
library(ggh4x) ## for nested facets

library(knitr) # For include_graphics

source(here::here("lib", "load_process", "load_process.R"))
source(here::here("lib", "util.R"))
source(here::here("lib", "demographics.R"))
source(here::here("lib", "plots.R"))
source(here::here("lib", "3c_analyze_shape", "stats.R"))

## Colors for plots
plot_blue <- c("#337aB7")
plot_colors <- c("#4477AA",
                 "#EE6677",
                 "#CCBB44",
                 "#66CCEE",
                 "#AA3377",
                 "#228833",
                 "#BBBBBB")
```

```{r config}
proc_dir <- here::here("data", "proc_exp_n1008")
fig_dir <- here::here("figures", "exp_n1008_4x")
manual_cache_dir <- here::here("manual_cache", "exp_n1008_4a")

use_cached_models <- T

use_cached_figs <- F

if (use_cached_figs == TRUE) {
  use_cached_demofigs <- TRUE
  use_cached_rtfigs <- TRUE
} else if (use_cached_figs == FALSE) {
  use_cached_demofigs <- FALSE
  use_cached_rtfigs <- FALSE
}
```

```{r load_data}
## Load "the data" with all subjects & trials.
aah_long <- load_aah_long(proc_dir)

## Load summary data table (for quick demographic analyses)
## with all subjects.
aah_summary_all <- load_aah_summary(proc_dir)
```

```{r prepare_data}
#### PREPARE SUMMARY DATA FOR DEMOGRAPHICS ANALYSES
aah_summary <- filter_aah_summary_for_analysis(aah_summary_all) |>
  mutate(
    handedness_extremes = case_when(ehi == -100 ~ "Left",
                                    ehi == 100 ~ "Right",
                                    ehi > -100 & ehi < 100 ~ "Mixed")
  )


#### PREPARE TRIAL-LEVEL DATA FOR RT, ACCURACY ANALYSES
## Prepare "the data" (aah_long) for all analyses:
## Filter out practice trials, absent trials, and excluded subjects
## This data (all present trials, correct or incorrect) will be used for
## accuracy analyses
aah <- filter_aah_long_for_analysis(aah_long) |>
  mutate(
    handedness_extremes = case_when(ehi == -100 ~ "Left",
                                    ehi == 100 ~ "Right",
                                    ehi > -100 &
                                      ehi < 100 ~ "Mixed")
  )

## For RT analyses, prepare dataset with only correct, present trials.
## In our RT model, we only care about correct responses to present trials.
aah_correct <- aah |> filter(correct == T)

#### PREPARE SUBJECT_LEVEL DATA FOR RT, ACCURACY ANALYSES
## Prepare subject-level data (RT)
rt_subject <- aah_correct |> group_by(subject, field, level, handedness) |>
  summarize(rt = median(rt))

## Prepare subject-level LVF Global bias summary (RT)
rt_1 <- rt_subject |>
  pivot_wider(names_from = c(field, level),
              values_from = rt) |>
  mutate(LVF_Global_Bias = (RVF_Global - RVF_Local) - (LVF_Global - LVF_Local)) |>
  mutate(all_one_group = "all_one_group")


```


## Scatter plot {.tabset}

### All points

```{r plot_rt_1_cor_dots}
plot_color = plot_blue
middle_purple1 <- "#996F91" ## In between plot colors one and two
middle_purple2 <- "#886e92" ## In between plot colors one and two

h_plot_colors <- c(plot_colors[[1]], middle_purple1, plot_colors[[2]])

fig_path_var <- here(fig_dir, "rt_1_cor_dots.png")
fig_path_var_wide <- here(fig_dir, "rt_1_cor_dots_wide.png")

if (use_cached_rtfigs == F) {
  
  rt_subject_plot <- rt_subject |>
    pivot_wider(names_from = c(field, level),
                values_from = rt) |>
    mutate(LVF_Global_Bias = (RVF_Global - RVF_Local) - (LVF_Global - LVF_Local)) |>
    left_join(aah_summary, by = c("subject", "handedness")) |>
    select(subject, ehi, starts_with("LVF"), handedness, handedness_extremes)
  
  g <- gg_rt_1_cor(title = "Global bias asymmetry by EHI",
              rt_subject_plot = rt_subject_plot,
              plot_colors = h_plot_colors)
  
  
  ggsave(fig_path_var, g, "png", height = 4, width = 4)
  ggsave(fig_path_var_wide, g, "png", height = 4, width = 8)
  
}

include_graphics(fig_path_var_wide)
```

```{r plot_rt_2_cor_dots}
fig_path_var <- here(fig_dir, "rt_2_cor_dots.png")

if (use_cached_rtfigs == F) {
  
  rt_subject_plot <- rt_subject |>
    pivot_wider(names_from = c(field),
                values_from = rt) |> 
    mutate(LVF_Bias = RVF - LVF) |> 
    left_join(aah_summary, by = c("subject", "handedness")) |>
    select(subject, ehi, level, starts_with("LVF"), handedness, handedness_extremes)
  
  g <- gg_rt_2_cor(title = "Hemifield bias for global and local targets, by EHI",
              rt_subject_plot = rt_subject_plot,
              plot_colors = h_plot_colors)
  
  ggsave(fig_path_var, g, "png", height = 4, width = 8)
}

include_graphics(fig_path_var_wide)
```

```{r plot_rt_4_cor_dots}
fig_path_var <- here(fig_dir, "rt_4_cor_dots.png")

if (use_cached_rtfigs == F) {
  
  rt_subject_plot <- rt_subject |>
    group_by(field, level) |>
    left_join(aah_summary, by = c("subject", "handedness")) |> 
    select(subject, ehi, field, level, rt, handedness, handedness_extremes)
  
  rt_subject_plot
  g <- gg_rt_4_cor(title = "Hemifield bias for global and local targets, by EHI",
              rt_subject_plot = rt_subject_plot,
              plot_colors = h_plot_colors)
    
  
  ggsave(fig_path_var, g, "png", height = 8, width = 8)
  
}

include_graphics(fig_path_var_wide)
```



### Summary stats only

```{r plot_rt_1_cor_bins}
plot_color = plot_blue
middle_purple1 <- "#996F91" ## In between plot colors one and two
middle_purple2 <- "#886e92" ## In between plot colors one and two

h_plot_colors <- c(plot_colors[[1]], middle_purple1, plot_colors[[2]])

fig_path_var <- here(fig_dir, "rt_1_cor_dots.png")
fig_path_var_wide <- here(fig_dir, "rt_1_cor_dots_wide.png")

if (use_cached_rtfigs == F) {
  
  rt_subject_plot <- rt_subject |>
    pivot_wider(names_from = c(field, level),
                values_from = rt) |>
    mutate(LVF_Global_Bias = (RVF_Global - RVF_Local) - (LVF_Global - LVF_Local)) |>
    left_join(aah_summary, by = c("subject", "handedness")) |>
    select(subject, ehi, starts_with("LVF"), handedness, handedness_extremes) |> 
    ## For easy reusable function
    mutate(dv = LVF_Global_Bias) |> 
    ungroup()
  
  # g <- gg_rt_1_ntiles(title = "Global bias asymmetry by EHI",
  #             rt_subject_plot = rt_subject_plot,
  #             plot_colors = h_plot_colors)
  
  title = "Global bias asymmetry by EHI"
  
    
    
    ##### Can be put into function: find_quantile_values()
    n_bins = 16
    ## Add variable for bin
    bin_data <- rt_subject_plot |> mutate(
      bin = cut_interval(ehi, n_bins)
    ) 
    ## Calculate mean, sem by quantile.
    ## No  need -- use per subject data in ggplot
    # group_by(bin) |> 
    #   summarize(mean_ehi = mean(ehi), # for sanity check
    #             mean_dv = mean(dv),
    #             n = n(),
    #             sem_dv = sd(dv)/sqrt(n)
    #             )
    
    bin_data
    
    ggplot(data = bin_data, aes(x = ehi, y = dv)) +
      stat_summary(
        fun.data = mean_se,
        geom = "errorbar",
        position = "dodge",
        linetype = 1,
        color = "gray5",
        width = .3,
        show.legend = F
      ) +
      # stat_summary(
      #   aes(y = dv),
      #   fun.data = mean,
      #   geom = "point",
      #   color = "black",
      #   shape = 21,
      #   show.legend = F
      # )
      # geom_point(
      #   data = rt_descriptive_plot,
      #   aes(y = mean),
      #   color = "black",
      #   shape = 21,
      #   show.legend = F
      # ) +
      
  ### For plot function
  rt_subject_plot_proc <- rt_subject_plot


  ## Prepare data to annotate first facet
  data_facet1 <- rt_subject_plot_proc

  g <- rt_subject_plot_proc |> ggplot(aes(x = ehi, y = LVF_Global_Bias)) +
    geom_hline(yintercept = 0, color = "gray50", linewidth = .5) +
    geom_quasirandom( alpha = .2, aes(fill = handedness), shape = 21, show.legend = F
    ) +
    geom_smooth(method = "lm", color = "gray30") +
    scale_fill_manual(values = h_plot_colors) +
    scale_color_manual(values = plot_colors[c(1, 2)]) +
    geom_text( data = data_facet1, color = "gray50",
      x = 0, y = 310, hjust = "center",
      label = "↑ \n LVF Bias" , size = 3
    ) +
    geom_text(data = data_facet1, color = "gray50",
      x = 1.55, y = -350, hjust = "center",
      label = "RVF Bias \n ↓", size = 3
    ) +
    scale_y_continuous(breaks = seq(-1000, 1000, 50),
                    minor_breaks = seq(-1000 , 1000, 25)) +
    coord_cartesian(ylim = c(-400, 350)) +
    labs(x = "Laterality quotient from EHI", y = "RVF - LVF, Local - Global reaction time (ms)",
         title = title)

  g <- g |> gg_style() +
    theme(
      aspect.ratio = 1/1,
      plot.title = element_text(hjust = 0.5),
      axis.title.x = element_text(margin = margin(t = 8, unit = "pt")),
      panel.grid.minor = element_line(color = "gray92", linewidth = .2),
      panel.grid.major.y = element_line(color = "gray92", linewidth = .4),
      panel.grid.major.x = element_line(color = "gray92", linewidth = .2),
      panel.border = element_rect(fill = NA, color = "gray50"))

  g + theme(plot.title = element_text(hjust = 0.5))
  
  
  ggsave(fig_path_var, g, "png", height = 4, width = 4)
  ggsave(fig_path_var_wide, g, "png", height = 4, width = 8)
  
}

include_graphics(fig_path_var_wide)
```





```{r}
## Snipet from CH:
## Depends on analyses/professions/lib/es_functions.R
find_quantile_counts <- function(hand_data, n_quantiles) {

  ## Add variable for quantile
  hand_data <- hand_data %>%
    mutate(quantile = as.factor(ntile(desc(occ_creative), n_quantiles)))

  ## Count n and percent leftire by quantile
  counts <- hand_data %>%
    group_by(quantile, handedness) %>%
    dplyr::summarize(n = n()) %>%
    pivot_wider(names_from = handedness,
                names_glue = "n_{handedness}", values_from = n) %>%
    mutate(n_left = replace_na(n_left, 0)) %>%
    mutate(n_total = n_right + n_left) %>%
    mutate(percent_left =  (n_left / n_total) * 100) %>%
    ## Depends on analyses/professions/lib/es_functions.R
    mutate(lower = (find_prop_score(n_left, n_total) %>% .[["lower"]]) * 100,
           upper = (find_prop_score(n_left, n_total) %>% .[["upper"]]) * 100)
    return(counts)
}


find_total_count <- function(counts) {
  ## Find overall mean proportion
  total_count <- counts %>%
    ungroup() %>%
    dplyr::summarize(n_left = sum(n_left),
              n_right = sum(n_right),
              n_total = sum(n_total),
              percent_left = (sum(n_left) / sum(n_total)) * 100) %>%
    ## Depends on analyses/professions/lib/es_functions.R
    mutate(lower = (find_prop_score(n_left, n_total) %>% .[["lower"]]) * 100,
           upper = (find_prop_score(n_left, n_total) %>% .[["upper"]]) * 100)
  return(total_count)
}


## X axis: n bins, one for each quantile of creativity ratings.
## Then, to visualize:
## Y axis: (1) Dot showing proportion of lefties
## Y axis: (2) Line error bounds showing 95% CI
## - Add horizontal line sample mean proportion, with error bounds
graph_quantile_counts <- function(counts, y_limits = c(5, 15), title = "") {
  n_quantiles <- length(counts$quantile)

  g <- ggplot(data = counts, aes(x = fct_rev(quantile), y = percent_left)) +
    ## Hack for error "Discrete value... continuous scale"
    geom_point(shape = NA) +
    ## Add ribbon, line showing sample mean and CI
    geom_ribbon(aes(x = 1:n_quantiles,
                    ymin = total_count$lower, ymax = total_count$upper),
                fill = "gray70", alpha = .2) +
    geom_line(aes(x = 1:n_quantiles, y = total_count$percent_left),
              size = .1, color = "gray10", linetype = "dashed") +
    ## Add error bars
    geom_errorbar(aes(ymin = lower, ymax = upper), width = .3) +
    labs(title = title,
         x = "Originality/Inductive Reasoning Quantile",
         y = "% Left-handed") +
    geom_point() +
    scale_y_continuous(limits = y_limits, expand = c(0, 0))
  g <- g %>% gg_style()
}


print_quantile_counts <- function(counts) {
  counts %>%
    arrange(quantile) %>%
    mutate(ci = str_c("[", lower, ", ", upper, "]")) %>%
    select(quantile, n_total, n_left, n_right, percent_left, ci) %>%
    rename(Quantile = quantile, n = n_total, `% left` = percent_left,
           `n (left)` = n_left, `n (right)` = n_right, `95% CI` = ci) %>%
    head(20) %>%
    pretty_table(digits = 2)
}

```





