---
title: "Action Asymmetry Experiment (interim sample, n = 602): Analyses"
pagetitle: "aah | pilot | analysis"
author: "Owen Morgan"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

<style type="text/css">
  body{
  font-family: Avenir;
  font-size: 12pt;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.align = "center", fig.width = 9,
                      fig.height = 6, results = "asis")
options(knitr.kable.NA = "")

cli.progress_show_after <- 0

## Do not use scientific notation until 9 decimal places.
options(scipen = 9, digits = 9)

# Suppress summarise info
options(dplyr.summarise.inform = FALSE)
```

```{r lib}
library(here)
library(tidyverse)
library(cli) # For printing error messages

library(lme4)
library(emmeans)
library(broom)
library(gt)

library(ggpubr) ## functions for plotting SD, SEM, CI.
library(ggbeeswarm)
library(patchwork)

library(knitr) # For include_graphics

source(here::here("lib", "load_process", "load_process.R"))
source(here::here("lib", "util.R"))
source(here::here("lib", "demographics.R"))
source(here::here("lib", "plots.R"))

## Colors for plots
plot_blue <- c("#337aB7")
plot_colors <- c("#4477AA",
                 "#EE6677",
                 "#CCBB44",
                 "#66CCEE",
                 "#AA3377",
                 "#228833",
                 "#BBBBBB")
```

```{r config}
proc_dir <- here::here("data", "proc_exp_n602")
fig_dir <- here::here("figures", "exp_n602")
manual_cache_dir <- here::here("manual_cache", "exp_n602")

use_cached_model_rt <- TRUE
use_cached_model_rt_complex <- TRUE
use_cached_model_acc <- TRUE
use_cached_model_acc_complex <- TRUE
use_cached_model_rt_ehi <- TRUE
use_cached_model_acc_ehi <- TRUE

use_cached_figs <- TRUE

if (use_cached_figs == TRUE) {
  use_cached_demofigs <- TRUE
  use_cached_rtfigs <- TRUE
  use_cached_accfigs <- TRUE
} else if (use_cached_figs == FALSE) {
  use_cached_demofigs <- FALSE
  use_cached_rtfigs <- FALSE
  use_cached_accfigs <- FALSE
}
```

# {.tabset}
```{r load_data}
## Load "the data" with all subjects & trials.
aah_long <- load_aah_long(proc_dir)

## Load summary data table (for quick demographic analyses)
## with all subjects.
aah_summary_all <- load_aah_summary(proc_dir)
```

```{r prepare_data}
#### PREPARE SUMMARY DATA FOR DEMOGRAPHICS ANALYSES
aah_summary <- filter_aah_summary_for_analysis(aah_summary_all)
## Code handedness
aah_summary <- aah_summary |> 
  mutate(
  handedness = case_when(
    ehi <= -40 ~ "Left",
    ehi >= 40 ~ "Right",
    ehi > -40 & ehi < 40 ~ "Mixed"
  )
)

#### PREPARE TRIAL-LEVEL DATA FOR RT, ACCURACY ANALYSES
## Prepare "the data" (aah_long) for all analyses:
## Filter out practice trials, absent trials, and excluded subjects
## This data (all present trials, correct or incorrect) will be used for
## accuracy analyses
aah <- filter_aah_long_for_analysis(aah_long)
aah <- aah |> 
  mutate(
  handedness = case_when(
    ehi <= -40 ~ "Left",
    ehi >= 40 ~ "Right",
    ehi > -40 & ehi < 40 ~ "Mixed"
  )
)

## For RT analyses, prepare dataset with only correct, present trials.
## In our RT model, we only care about correct responses to present trials.
aah_correct <- aah |> filter(correct == T)
## Code handedness

## Relevel field and level with RVF first (unintuitive for plotting),
## so that emmeans will show a positive number for LVF global bias.
aah_for_rt_model <- aah_correct |>
  mutate(level = level |> factor(levels = c("Global", "Local")),
         field = field |> factor(levels = c("RVF", "LVF")))

## For accuracy analyses, prepare dataset will all present trials.
## Relevel field and level,
## so that emmeans will show a positive number for LVF global bias.
aah_for_acc_model <- aah |>
  mutate(level = level |> factor(levels = c("Global", "Local")),
         field = field |> factor(levels = c("RVF", "LVF")))

#### PREPARE SUBJECT_LEVEL DATA FOR RT, ACCURACY ANALYSES
## Prepare subject-level data (RT)
rt_subject <- aah_correct |> group_by(subject, field, level, handedness) |>
  summarize(rt = median(rt))

## Prepare subject-level LVF Global bias summary (RT)
rt_1 <- rt_subject |>
  pivot_wider(names_from = c(field, level),
              values_from = rt) |>
  mutate(LVF_Global_Bias = (RVF_Global - RVF_Local) - (LVF_Global - LVF_Local)) |>
  mutate(all_one_group = "all_one_group")

## Prepare subject-level LVF Global bias summary (Accuracy)
## (For accuracy, include incorrect trials!)
acc_subject <- aah |> group_by(subject, field, level, handedness) |>
  summarize(
    total_responses = n(),
    n_present_resp = sum(correct),
    n_absent_resp = total_responses - n_present_resp,
    n_correct = sum(correct),
    acc = 100 * (n_correct / total_responses)
  ) |>
  select(subject, field, level, acc) |>
  mutate(level = recode(level, global = "Global", local = "Local"))

acc_1 <- acc_subject |>
  pivot_wider(names_from = c(field, level),
              values_from = acc) |>
  mutate(LVF_Global_Bias = (LVF_Global - LVF_Local) - (RVF_Global - RVF_Local)) |>
  mutate(all_one_group = "all_one_group")
```

## Demographics {.tabset .tabset-pills}

### Everyone

Demographics for all included participants.
```{r demo_summary}
rt_demo <- demo_summary_table(aah_summary)
rt_demo |> pretty_table() |> tab_header(title = "Demographics", subtitle = "Summary")
```
<br>
```{r demo_plot_config}
plot_color = plot_blue
```

```{r demo_plot_ehi}
fig_path <- here(fig_dir, "demo_ehi.png")

if (use_cached_demofigs == FALSE) {
g <- ggplot(aah_summary, aes(x = ehi)) +
  geom_histogram(color = NA, fill = plot_color, alpha = .8, binwidth = 8, boundary = 100) +
  labs(x = "EHI")+
  xlim(c(-104, 104))

g <- g |> gg_style_demo() + theme(aspect.ratio = 1/2,
                            axis.title.y = element_blank())

ggsave(fig_path, g, "png", height = 2, width = 4)
}

include_graphics(fig_path)
```

```{r demo_plot_age}
fig_path <- here(fig_dir, "demo_age.png")

if (use_cached_demofigs == FALSE) {
g <- ggplot(aah_summary, aes(x = age)) +
  geom_histogram(color = NA, fill = plot_color, alpha = .8, binwidth = 1) +
  labs(x = "Age (years)")

g <- g |> gg_style_demo() + theme(aspect.ratio = 1/2,
                            axis.title.y = element_blank())

ggsave(fig_path, g, "png", height = 2, width = 4)
}

include_graphics(fig_path)
```

```{r demo_plot_edu}
fig_path <- here(fig_dir, "demo_edu.png")

if (use_cached_demofigs == FALSE) {
g <- ggplot(aah_summary, aes(x = education)) +
  geom_histogram(color = NA, fill = plot_color, alpha = .8, binwidth = 1) +
  labs(x = "Education (years)")

g <- g |> gg_style_demo() + theme(aspect.ratio = 1/2,
                            axis.title.y = element_blank(),
                            axis.text.y = element_blank())

ggsave(fig_path, g, "png", height = 2, width = 4)
}

include_graphics(fig_path)
```
<br>
```{r demo_race}
demo_race_table(aah_summary) |> pretty_table()
```
<br>
```{r demo_ethnicity}
demo_ethnicity_table(aah_summary) |> pretty_table()
```
<br>

### By handedness group {.active}

Demographics for included participants, by handedness group (EHI bins). 
```{r}
hand_demo_summary_table(aah_summary) |> pretty_table() |>
  tab_footnote("Left: (EHI <= -40)  |  Mixed: (-40 < EHI < 40)  |  Right: (EHI >= 40)")
```
<br>
```{r demo_plot_ehi_binned}
fig_path <- here(fig_dir, "demo_ehi_binned.png")

if (use_cached_demofigs == FALSE) {
g <- ggplot(aah_summary, aes(x = ehi)) +
  geom_vline(xintercept = -36, color = "gray50") +
  geom_vline(xintercept = 36, color = "gray50") +
  geom_histogram(color = NA, fill = plot_color, alpha = .8, binwidth = 8, boundary = 100) +
  labs(x = "EHI")+
  xlim(c(-104, 104))

g <- g |> gg_style_demo() + theme(aspect.ratio = 1/2,
                            axis.title.y = element_blank())

ggsave(fig_path, g, "png", height = 2, width = 4)
}

include_graphics(fig_path)
```


## Field x Level x Handedness (binned) {.tabset .tabset-pills}
Within each handedness group, do we see the typical field x level interaction? That is, do participants show a relative bias for global shapes in the left visual field (LVF)?
<br>
<br>
<!-- ***Summary.*** We see the predicted effect, for both reaction time (30ms) and accuracy (OR = 1.6). The RT laterality effect is marginally stronger for squares (40ms) than for circles (18ms; p = .13), and there is a trend in the same direction for accuracy (OR = 1.7, p = .16). <br> -->
<!-- Squares (46ms) but not circles (2.8ms) show an overall global precedence effect (Accuracy: OR 2.1/1.1). Maybe, global precedence and the global precedence laterality effect are weaker for circles because both global and local circles are highly visible. -->

### Reaction time {.tabset}

#### Plots

Error bars show 95% CI.
```{r plot_rt_config}
plot_color <- plot_colors[[5]] # Color for interaction plots with only one color.
```

```{r plot_rt_4a_all_trials}
## Plot data from every trial, with overall mean, median and bounds.
fig_path_rt_4a <- here(fig_dir, "rt_4a.png")


if (use_cached_rtfigs == FALSE) {
rt_descriptive <- aah_correct |>
  group_by(field, level, handedness) |>
  summarize(
    median = median(rt),
    mean = mean(rt),
    SE = sd(rt) / sqrt(length((rt)))
  )

## Facet by: Visual field, handedness
g <- ggplot(aah_correct, aes(
  x = level,
  y = rt,
  fill = level,
  color = level,
)) +
  geom_quasirandom(alpha = .05, show.legend = F) +
  geom_boxplot(
    alpha = 0.5,
    size = 0.3,
    varwidth = F,
    outlier.shape = NA,
    color = "gray20",
    show.legend = F
  ) +
  stat_summary(
    fun.data = mean_cl_normal,
    fun.args = list(conf.int = 0.95),
    geom = "errorbar",
    position = "dodge",
    linetype = 1,
    color = "gray5",
    width = .3,
    # size = point_size / 5,
    show.legend = F
  ) +
  geom_point(data = rt_descriptive, aes(y = mean), color = "black", shape = 21,
             show.legend = F) +
  scale_y_continuous(minor_breaks = seq(0 , 2000, 100),
                     breaks = seq(0, 2000, 200)) +
  facet_grid(vars(handedness), vars(field)) +
  labs(title = "All trials (RT)", x = "Level", y = "Reaction time (ms)")

g <- g |> gg_style_means() |> gg_color()
ggsave(fig_path_rt_4a, g, "png", height = 8, width = 4)
g_rt_4a <- g
}

include_graphics(fig_path_rt_4a)
```
<br>

---

<br>
```{r plot_rt_4}
fig_path_rt_4 <- here(fig_dir, "rt_4.png")

if (use_cached_rtfigs == FALSE) {
rt_subject <- aah_correct |>
  group_by(subject, field, level, handedness) |> 
  summarize(rt = median(rt))

rt_descriptive <- rt_subject |>
  group_by(field, level, handedness) |>
  summarize(
    median = median(rt),
    mean = mean(rt),
    SE = sd(rt) / sqrt(length((rt)))
  )

g <- ggplot(rt_subject, aes(
  x = level,
  y = rt,
  fill = level,
  color = level
)) +
  geom_quasirandom(alpha = .1, show.legend = F) +
  geom_boxplot(
    alpha = 0.5,
    size = 0.3,
    varwidth = F,
    outlier.shape = NA,
    color = "gray20",
    show.legend = F
  ) +
  stat_summary(
    fun.data = mean_cl_normal,
    fun.args = list(conf.int = 0.95),
    geom = "errorbar",
    position = "dodge",
    linetype = 1,
    color = "gray5",
    width = .2,
    # size = point_size / 5,
    show.legend = F
  ) +
  geom_point(
    data = rt_descriptive,
    aes(y = mean),
    color = "black",
    shape = 21,
    show.legend = F
  ) +
  scale_y_continuous(minor_breaks = seq(0 , 1500, 100),
                     breaks = seq(0, 1500, 200)) +
  facet_grid(vars(handedness), vars(field)) +
  labs(title = "Per-subject medians (RT)", x = "Level", y = "Reaction time (ms)")

g <- g |>  gg_style_means() |> gg_color()
ggsave(fig_path_rt_4, g, "png", height = 8, width = 4)
g_rt_4 <- g
}

include_graphics(fig_path_rt_4)
```
```{r plot_rt_4a4}
# fig_path_rt_4a4 <- here(fig_dir, "rt_combo_4a-4.png")
# 
# if (use_cached_rtfigs == FALSE) {
# g_rt_4a4 <- g_rt_4a + g_rt_4
# g_rt_4a4
# ggsave(fig_path_rt_4a4, g_rt_4a4, "png", height = 4, width = 8)
# }
# 
# include_graphics(fig_path_rt_4a4)
```

---

```{r plot_rt_2}
fig_path_rt_2 <- here(fig_dir, "rt_2.png")

if (use_cached_rtfigs == FALSE) {
## Make a table showing:
## For each subject and field, the difference in median rt for:
## Global - Local
rt_2 <- rt_subject |> 
  pivot_wider(names_from = c(level),
              values_from = rt) |> 
  mutate(Global_Bias = Local - Global)

rt_descriptive <- rt_2 |>
  group_by(field, handedness) |>
  summarize(
    median = median(Global_Bias),
    mean = mean(Global_Bias),
    SE = sd(Global_Bias) / sqrt(length((Global_Bias)))
  )

g <- ggplot(rt_2, aes(x = field,
                      y = Global_Bias, fill = handedness, color = handedness)) +
  geom_quasirandom(
    alpha = .1, show.legend = F,
    # color = plot_color
    ) +
  geom_boxplot(
    alpha = 0.5,
    size = 0.3,
    varwidth = F,
    outlier.shape = NA,
    # fill = plot_color,
    color = "gray20",
    show.legend = F
  ) +
  stat_summary(
    fun.data = mean_cl_normal,
    fun.args = list(conf.int = 0.95),
    geom = "errorbar",
    position = "dodge",
    linetype = 1,
    color = "gray5",
    width = .2,
    show.legend = F
  ) +
  geom_point(
    data = rt_descriptive,
    aes(y = mean),
    # fill = plot_color,
    color = "gray5",
    shape = 21,
    show.legend = F
  ) +
  facet_wrap(~handedness)+
  scale_y_continuous(minor_breaks = seq(-500 , 500, 50),
                     breaks = seq(-500, 500, 100)) +
  scale_fill_manual(values = plot_colors[c(1, 5,  2)]) +
  scale_color_manual(values = plot_colors[c(1, 5,  2)]) +
  labs(title = "Global bias (RT)", x = "Level", y = "Local - Global RT (ms)")

g <- g |> gg_style_means()
ggsave(fig_path_rt_2, g, "png", height = 4, width = 4)
g_rt_2 <- g
}

include_graphics(fig_path_rt_2)
```

---

```{r plot_rt_1}
fig_path_rt_1 <- here(fig_dir, "rt_1.png")

if (use_cached_rtfigs == FALSE) {
  ## Make a table showing:
  ## For each subject and field, the difference in median rt for:
  ## Global - Local
  rt_1 <- rt_subject |>
    pivot_wider(names_from = c(field, level),
                values_from = rt) |>
    mutate(LVF_Global_Bias = (RVF_Global - RVF_Local) - (LVF_Global - LVF_Local)) |>
    mutate(all_one_group = "all_one_group")
    
rt_descriptive <- rt_1 |>
  group_by(all_one_group, handedness) |> 
  summarize(
    median = median(LVF_Global_Bias),
    mean = mean(LVF_Global_Bias),
    SE = sd(LVF_Global_Bias) / sqrt(length((LVF_Global_Bias)))
  )

g <- ggplot(rt_1, aes(
  x = all_one_group,
  y = LVF_Global_Bias,
  fill = handedness,
  color = handedness
)) +
  geom_quasirandom(
    alpha = .1, show.legend = F,
    # color = plot_color
    ) +
  geom_boxplot(
    alpha = 0.5,
    size = 0.3,
    varwidth = F,
    outlier.shape = NA,
    color = "gray20",
    # fill = plot_color,
    show.legend = F
  ) +
  stat_summary(
    fun.data = mean_cl_normal,
    fun.args = list(conf.int = 0.95),
    geom = "errorbar",
    position = "dodge",
    linetype = 1,
    color = "gray5",
    width = .2,
    # size = point_size / 5,
    show.legend = F
  ) +
  geom_point(
    data = rt_descriptive,
    aes(y = mean),
    # fill = plot_color,
    color = "black",
    shape = 21,
    show.legend = F
  ) +
  facet_wrap(~handedness) +
  scale_y_continuous(minor_breaks = seq(-500 , 500, 50),
                     breaks = seq(-500, 500, 100)) +
  scale_fill_manual(values = plot_colors[c(1, 5,  2)]) +
  scale_color_manual(values = plot_colors[c(1, 5,  2)]) +
  theme(axis.text.x = element_blank()) +
  labs(title = "LVF>RVF Global Bias (RT)", x = "Level", y = "RVF - LVF, Local - Global RT (ms)")

g <- g |> gg_style_means() +
  theme(axis.text.x = element_blank(), aspect.ratio = 4/1)
g
ggsave(fig_path_rt_1, g, "png", height = 4, width = 4)
g_rt_1 <- g
}

include_graphics(fig_path_rt_1)
```
```{r plot_rt_21}
# fig_path_rt_21 <- here(fig_dir, "rt_combo_2-1.png")
# 
# if (use_cached_rtfigs == FALSE) {
# g_rt_1_padded <- g_rt_1 + theme(plot.margin = unit(c(10, 50, 5.5, 40), "pt"))
# g_rt_21 <- g_rt_2 + g_rt_1_padded
# ggsave(fig_path_rt_21, g_rt_21, "png", height = 4, width = 8)
# }
# 
# include_graphics(fig_path_rt_21)
```

#### Statistics

##### Simple mixed regression model
Reaction time is modeled as a linear effect of field and level, using data from every target-present trial with a "go" response:
<br>
<br>
`lmer( rt ~ field*level*handedness + (1 | subject) )`
<br>
<br>

```{r rt_model_test}
## Make a model with two handedness bins: Right and Left
aah_for_rt_model_2bins <- aah_for_rt_model |> filter(handedness %in% c("Right", "Left"))
rt_model_2bins <- lmer(rt ~ field*level*handedness + field + level + (1 | subject), data = aah_for_rt_model_2bins)

if (use_cached_model_rt == FALSE) {
  ## Create emmeans model object, and manually cache it.
  rt_emm_2bins <- emmeans(rt_model_2bins, ~ field * level * handedness)
  ## Todo: run without z-approximation:
  # rt_emm <- emmeans(rt_model, ~ field * level * handedness, pbkrtest.limit = 59851)
  
  ## Manually cache model
  saveRDS(rt_emm_2bins, here(manual_cache_dir, "rt_emm_2bins.rds"))
  
} else if (use_cached_model_rt == TRUE) {
  ## Load cached model
  rt_emm_2bins <- readRDS(here(manual_cache_dir, "rt_emm_2bins.rds"))
}
```
```{r}
## Make a model with three handedness bins: Right and Left
rt_model_3bins <- lmer(rt ~ field*level*handedness + field + level + (1 | subject), data = aah_for_rt_model)

if (use_cached_model_rt == FALSE) {
  ## Create emmeans model object, and manually cache it.
  rt_emm_3bins <- emmeans(rt_model_3bins, ~ field * level * handedness)
  ## Todo: run without z-approximation:
  # rt_emm <- emmeans(rt_model, ~ field * level * handedness, pbkrtest.limit = 59851)
  
  ## Manually cache model
  saveRDS(rt_emm_3bins, here(manual_cache_dir, "rt_emm_3bins.rds"))
  
} else if (use_cached_model_rt == TRUE) {
  ## Load cached model
  rt_emm_3bins <- readRDS(here(manual_cache_dir, "rt_emm_3bins.rds"))
}
```


<br>
```{r rt_interaction_anova}
## Use anova() on competing models to test 2-way interaction.
interaction_stats <-
  function(model_with_interaction,
           model_with_no_interaction) {
    return(anova(model_with_interaction, model_with_no_interaction))
  }

rt_model_no_interaction <- update(rt_model_2bins, . ~ . - field:level:handedness)
interaction_anova <- interaction_stats(rt_model_2bins, rt_model_no_interaction)
interaction_anova |>
  as_tibble() |>
  rename(p.value = `Pr(>Chisq)`) |> 
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = "Field by level by handedness interaction (RT)", 
             subtitle = "ANOVA: compare models with vs. without interaction term") 
```
<br>
```{r rt_interacion_aov}
## Use aov to test 2-way interaction with a traditional F-test.
rt_aov <- aov(rt ~ field*level*handedness, data = aah_for_rt_model_2bins)
rt_aov_summary <- summary(rt_aov)
rt_aov_summary |> (\(.) .[[1]])() |> tidy() |>
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = "Field by level interaction (RT)",
             subtitle = "Omnibus F-test")
```
<br>

```{r rt_interaction_emm}
## Use emmeans() to test 3-way interaction.
rt_interaction_emm <- rt_emm_2bins |> 
  contrast(interaction = c("consec")) |>
  summary(infer = T)

rt_interaction_emm |>
  as_tibble() |>
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = "Field by level by handedness interaction (RT)",
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means LVF global bias is stronger in right handers (as predicted by AAH)",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>
```{r rt_handedness_bias}
## Estimate the effect of field by level for each handedness group
rt_emm2 <- emmeans(rt_model_3bins, ~field*level | handedness) |>
  contrast(interaction = "consec") |>
  summary(infer = T, adj = "none")

rt_emm2 |>
  as_tibble() |> 
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = "LVF Global bias by handedness bin (RT)") |>
  tab_footnote(footnote = "A positive number means global bias (faster RT for global)",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>

### Accuracy
***In progress.*** 


## Field x Level x Handedness (continuous) {.tabset .tabset-pills}

### Reaction time
```{r}
rt_ehi_1 <- rt_1 |>
  left_join(aah_summary |> select(subject, ehi)) |>
  select(subject, ehi, LVF_Global_Bias)
```


#### Plots
```{r}
fig_path_rt_ehi_cor <- here(fig_dir, "rt_ehi_cor.png")
fig_path_rt_ehi_cor_wide <- here(fig_dir, "rt_ehi_cor_wide.png")
g <- rt_ehi_1 |> ggplot(aes(x = ehi, y = LVF_Global_Bias)) +
  geom_beeswarm(alpha = .2) +
  geom_smooth(method = "lm", color = "black") +
  labs(x = "EHI", y = "RVF - LVF, Local - Global RT (ms)",
       title = "EHI and each subject's mean LVF global bias")

g <- g |> gg_style()
ggsave(fig_path_rt_ehi_cor, g, "png", height = 4, width = 4)
ggsave(fig_path_rt_ehi_cor_wide, g, "png", height = 4, width = 8)
```
```{r}
include_graphics(fig_path_rt_ehi_cor_wide)
```


#### Statistics

Model RT as a linear effect of field, level, and EHI (continuous):
<br>
<br>
`rt_ehi_model <- lmer( rt ~ field*level*ehi + (1 | subject) )`
<br>
<br>
```{r rt_ehi_model}
## Prepare data, so emmeans contrasts show
## Global bias as a positive number.
aah_for_rt_ehi_model <- aah_for_rt_model |>
  mutate(level = level |> factor(levels = c("Local", "Global")),
         field = field |> factor(levels = c("LVF", "RVF")))
```
```{r}
rt_model_ehi <- lmer(rt ~ field:level:ehi + field:level + field:ehi + level:ehi + field + level + ehi + (1 | subject), data = aah_for_rt_ehi_model)
```

```{r rt_ehi_model_caching}
if (use_cached_model_rt_ehi == FALSE) {
  ## Create emmeans model object, and manually cache it.
  ## TODO: run without z-score approximation.
  rt_emm_ehi <- emmeans(rt_model_ehi, ~ field * level * ehi)
  
  ## Manually cache model
  saveRDS(rt_emm_ehi, here(manual_cache_dir, "rt_emm_ehi.rds"))
  
} else if (use_cached_model_rt_ehi == TRUE) {
  ## Load cached model
  rt_emm_ehi <- readRDS(here(manual_cache_dir, "rt_emm_ehi.rds"))
}
```

```{r rt_ehi_interaction_anova, echo = T}
## Use anova() on competing models to test 3-way interaction.
interaction_stats <-
  function(model_with_interaction,
           model_with_no_interaction) {
    return(anova(model_with_interaction, model_with_no_interaction))
  }

rt_model_no_interaction <- update(rt_model_ehi, . ~ . - field:level:ehi)
interaction_anova <- interaction_stats(rt_model_ehi, rt_model_no_interaction)
interaction_anova |>
  as_tibble() |>
  rename(p.value = `Pr(>Chisq)`) |> 
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = "Field by level by ehi interaction (RT)", 
             subtitle = "ANOVA: compare models with vs. without interaction term") 
```

<br>
```{r}
## Estimate effect of ehi on field x level.
## (It should be .13)

## Use ref_grid (following quant 2 HW5)
ref <- ref_grid(rt_model_ehi, at = list(ehi = c(-100, 100)))
#ref |> summary(infer = T) |> as_tibble() |> filter(ehi == -100)

ref_L <- ref_grid(rt_model_ehi, at = list(ehi = c(-100)))
ref_R <- ref_grid(rt_model_ehi, at = list(ehi = c(100)))

L_tbl <- ref_L |> contrast("pairwise") |> as_tibble() |> slice(2, 5)
R_tbl <- ref_R |> contrast("pairwise") |> as_tibble() |> slice(2, 5)

L_tbl |> 
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = "Estimated global bias by field, for EHI of -100") |> 
  tab_footnote(footnote = "Estimated global bias (ms)",
               locations = cells_column_labels(columns = estimate))
  
## This shows the pairwise differences like RVF Global - RVF Local
## when ehi = -100.
```
<br>
<br>
```{r}
## Estimate LVF Global bias for EHI -100
pull_LVF_global_bias <- function(X_tbl) {
  X_LVF_est <-
    X_tbl |> slice(1) |> pull(estimate)
  
  X_RVF_est <-
    X_tbl |> slice(2) |> pull(estimate)
  
  X_LVF_global_bias <- (X_LVF_est - X_RVF_est)
  return(X_LVF_global_bias)
}

L_LVF_global_bias <- pull_LVF_global_bias(L_tbl)
L_LVF_global_bias |>
  as_tibble() |>
  rename(LVF_global_bias = value) |>
  pretty_table() |> 
  tab_header(title = "Estimated LVF Global Bias for EHI of -100") 
```
<br>
```{r}
R_tbl |> 
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = "Estimated global bias by field, for EHI of +100") |> 
  tab_footnote(footnote = "Estimated global bias (ms)",
               locations = cells_column_labels(columns = estimate))
## This shows the pairwise differences like RVF Global - RVF Local
## when ehi = +100.
```
<br>
```{r}
R_LVF_global_bias <- pull_LVF_global_bias(R_tbl)
R_LVF_global_bias |>
  as_tibble() |>
  rename(LVF_global_bias = value) |>
  pretty_table() |> 
  tab_header(title = "Estimated LVF Global Bias for EHI of +100")
```
<br>
$$
28.533 - 15.797 = 12.736ms \\
12.736/200 = 0.064ms / EHI unit
$$
Each unit change in EHI (-100:100) corresponds to a **0.064ms** difference in LVF global bias. This is the slope estimate given by the summary function:
<br>

```{r, echo = T, results = "markup"}
summary(rt_model_ehi)
```


### Accuracy
```{r}
acc_ehi_1 <- acc_1 |>
  left_join(aah_summary |> select(subject, ehi)) |>
  select(subject, ehi, LVF_Global_Bias)
```


#### Plots
```{r}
fig_path_acc_ehi_cor <- here(fig_dir, "acc_ehi_cor.png")
fig_path_acc_ehi_cor_wide <- here(fig_dir, "acc_ehi_cor_wide.png")
g <- acc_ehi_1 |> ggplot(aes(x = ehi, y = LVF_Global_Bias)) +
  geom_beeswarm(alpha = .2) +
  geom_smooth(method = "lm", color = "black") +
  labs(x = "EHI", y = "RVF - LVF, Local - Global % correct",
       title = "EHI and each subject's mean LVF global bias")

g <- g |> gg_style()
ggsave(fig_path_acc_ehi_cor, g, "png", height = 4, width = 4)
ggsave(fig_path_acc_ehi_cor_wide, g, "png", height = 4, width = 8)
```
```{r}
include_graphics(fig_path_acc_ehi_cor_wide)
```

#### Statistics

***In progress.*** Model accuracy as a binomial effect of field, level, and EHI (continuous):
<br>
<br>
`acc_ehi_model <- glmer( rt ~ field*level*ehi + (1 | subject), family = "binomial" )`
<br>
<br>
